name: Build with Gradle

on:
  workflow_dispatch:
#  push:
#    branches: [ "main" ]
#  pull_request:
#    branches: [ "main" ]

jobs:
  build:
    runs-on: ubuntu-latest
    env:
      GHIDRA_VERSION: '12.0'
      GHIDRA_DATE: 20251205
      GHIDRA_LIBS: >-
        Features/Base/lib/Base.jar
        Features/Decompiler/lib/Decompiler.jar
        Framework/Docking/lib/Docking.jar
        Framework/Generic/lib/Generic.jar
        Framework/Project/lib/Project.jar
        Framework/SoftwareModeling/lib/SoftwareModeling.jar
        Framework/Utility/lib/Utility.jar
        Framework/Gui/lib/Gui.jar
    
    steps:
      - uses: actions/checkout@v4
      
      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'
          distribution: 'temurin'
      
      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@v3
    
      - name: Download Ghidra
        run: |
          wget --no-verbose -O ghidra.zip https://github.com/NationalSecurityAgency/ghidra/releases/download/Ghidra_${{ env.GHIDRA_VERSION }}_build/ghidra_${{ env.GHIDRA_VERSION }}_PUBLIC_${{ env.GHIDRA_DATE }}.zip
          7z x -bd ghidra.zip
          echo "GHIDRA_INSTALL_DIR=${{ github.workspace }}/ghidra_${{ env.GHIDRA_VERSION }}_PUBLIC" >> $GITHUB_ENV
      
      - name: Copy Ghidra libs
        run: |
          mkdir -p ./lib
          for libfile in ${{ env.GHIDRA_LIBS }}
            do echo "Copying ${libfile} to lib/"
            cp ghidra_${{ env.GHIDRA_VERSION }}_PUBLIC/Ghidra/${libfile} ./lib/
          done
      
      - name: Build with Gradle
        run: gradle clean build jar
      
      - name: Prepare release
        run: |
          VERSION=$(grep "^version" build.gradle | sed "s/version *= *['\"]//g" | sed "s/['\"].*//g" || echo "1.0.0")
          CREATED_DATE=$(date +%Y-%m-%d)
          mkdir -p temp_inner/lib
          cp build/libs/*.jar temp_inner/lib/GhidraMCP.jar
          echo "name=GhidraMCP" > temp_inner/extension.properties
          echo "description=A plugin that runs an embedded HTTP server to expose program data." >> temp_inner/extension.properties
          echo "author=originallyLaurieWired" >> temp_inner/extension.properties
          echo "createdOn=${CREATED_DATE}" >> temp_inner/extension.properties
          echo "version=${VERSION}" >> temp_inner/extension.properties
          echo "ghidraVersion=${{ env.GHIDRA_VERSION }}" >> temp_inner/extension.properties
          echo "GHIDRA_MODULE_NAME=GhidraMCP" > temp_inner/Module.manifest
          echo "GHIDRA_MODULE_DESC=An HTTP server plugin for Ghidra" >> temp_inner/Module.manifest
          cd temp_inner
          zip -r ../GhidraMCP_v${VERSION}.zip .
          cd ..
          mkdir -p release
          cp bridge_mcp_ghidra.py release/
          cp GhidraMCP_v${VERSION}.zip release/
          cd release
          zip -r GhidraMCP-${VERSION}.zip bridge_mcp_ghidra.py GhidraMCP_v${VERSION}.zip
          cd ..
          rm -rf temp_inner
      
      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: GhidraMCP-artifact
          path: release/*
